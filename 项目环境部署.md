# 政府采购项目审查分析系统环境部署指南

本文档提供了在本地开发环境中设置和运行政府采购项目审查分析系统的详细步骤。系统包含RBAC权限控制、项目管理、文档管理、OCR文字识别和AI智能分析等核心功能。

## 🚀 最新更新 - AI集成版本 (v1.1.0)

### AI服务模块新增功能
- **文档向量化**: 基于bge-m3:latest模型的中文文档向量化
- **语义搜索**: 智能语义搜索和问答系统
- **智能分析**: 文档内容分析和风险评估
- **批量处理**: 高效的文档批量处理能力

### 技术架构升级
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   主应用服务    │───▶│   AI服务模块    │───▶│   向量数据库    │
│  (FastAPI:8000) │    │ (FastAPI:8001)  │    │ (PostgreSQL)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   SQLite/PG     │    │   Ollama服务    │    │   Redis缓存     │
│   (主数据库)    │    │  (LLM:11434)    │    │  (缓存:6379)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 1. 先决条件

### 基础环境
*   **Python**: 3.8 或更高版本
*   **Pip**: Python包管理工具
*   **Git**: 版本控制系统
*   **Docker**: 20.10+ (推荐，用于AI服务)
*   **Docker Compose**: 2.0+ (推荐)

### AI服务要求
*   **内存**: 最低8GB，推荐16GB+
*   **存储**: 最低20GB可用空间
*   **网络**: 稳定的互联网连接（用于下载AI模型）
*   **GPU**: 可选，支持NVIDIA GPU加速

## 2. 环境设置

### 2.1. 克隆仓库

```bash
# 使用你的仓库地址
git clone <repository-url>
cd <repository-directory>
```

### 2.2. 创建并激活虚拟环境

为了隔离项目依赖，强烈建议使用虚拟环境。

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境 (Windows)
.\venv\Scripts\activate

# 激活虚拟环境 (macOS/Linux)
# source venv/bin/activate
```

### 2.3. 安装依赖

#### 主应用依赖
```bash
pip install -r requirements.txt
```

#### AI服务依赖
```bash
pip install -r requirements-ai.txt
```

#### 或使用Docker一键部署（推荐）
```bash
# 启动所有服务（包括AI服务）
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

## 3. 数据库设置

本项目使用 `Alembic` 进行数据库迁移管理，并默认使用 `SQLite` 作为开发数据库。

### 3.1. 应用数据库迁移

首次运行时，需要应用迁移来创建数据库表结构。

```bash
alembic upgrade head
```

此命令会读取 `alembic.ini` 配置和 `alembic/` 目录下的迁移脚本，并在项目根目录下创建或更新 `test.db` 文件。

## 4. 运行应用程序

### 4.1. 方式一：Docker部署（推荐）

```bash
# 启动所有服务
docker-compose up -d

# 等待服务启动完成（约2-3分钟）
docker-compose logs -f ai-service

# 验证服务状态
curl http://localhost:8000/health
curl http://localhost:8001/health
```

### 4.2. 方式二：本地开发部署

#### 启动主应用服务
```bash
uvicorn app.main:app --reload --port 8000
```

#### 启动AI服务（新终端）
```bash
cd ai_service
uvicorn main:app --reload --port 8001
```

#### 启动Ollama服务（可选，用于本地LLM）
```bash
# 安装Ollama
curl -fsSL https://ollama.ai/install.sh | sh

# 启动Ollama服务
ollama serve

# 下载中文嵌入模型
ollama pull bge-m3:latest
```

### 4.3. 访问应用程序

服务器成功启动后，你可以在浏览器中访问以下地址：

#### 主应用服务
*   **API文档 (Swagger UI)**: [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)
*   **备选API文档 (ReDoc)**: [http://127.0.0.1:8000/redoc](http://127.0.0.1:8000/redoc)
*   **健康检查**: [http://127.0.0.1:8000/health](http://127.0.0.1:8000/health)

#### AI服务模块
*   **AI API文档**: [http://127.0.0.1:8001/docs](http://127.0.0.1:8001/docs)
*   **AI健康检查**: [http://127.0.0.1:8001/health](http://127.0.0.1:8001/health)
*   **AI性能指标**: [http://127.0.0.1:8001/metrics](http://127.0.0.1:8001/metrics)

### 4.4. 系统功能模块

#### 核心业务功能
*   **用户管理**: 支持用户注册、登录、角色管理和权限控制
*   **项目管理**: 项目创建、审查、状态跟踪和比对分析
*   **文档管理**: 文档上传、分类、版本控制和搜索
*   **OCR识别**: 文档文字识别、结果管理和统计分析
*   **问题跟踪**: 项目问题记录、分配和解决状态管理

#### AI智能功能（新增）
*   **文档向量化**: 自动将文档转换为向量表示
*   **语义搜索**: 基于语义理解的智能搜索
*   **智能问答**: 基于文档内容的问答系统
*   **文档分类**: 自动文档分类和标签
*   **风险评估**: 智能文档风险分析
*   **批量处理**: 高效的文档批量处理

### 4.5. 初始数据和测试

#### 初始化数据
首次启动时，系统会自动创建初始数据，包括：
*   默认管理员用户
*   基础角色和权限配置
*   示例项目数据
*   向量数据库表结构

```bash
# 手动初始化数据
python app/initial_data.py

# 初始化向量数据库
alembic upgrade head
```

#### 功能测试
```bash
# 运行主应用测试
pytest tests/ -v

# 运行AI服务测试
cd ai_service
pytest tests/ -v

# 运行文档向量化测试
python test_document_vectorization.py

# 运行完整测试套件
pytest --cov=app tests/
```

## 5. 环境配置

### 5.1. 环境变量配置

#### 主应用环境变量 (`.env`)
```env
# 数据库配置
DATABASE_URL=sqlite:///./test.db
# 生产环境推荐: postgresql://user:password@localhost:5432/audit_system

# 安全配置
SECRET_KEY=your-secret-key-here
ACCESS_TOKEN_EXPIRE_MINUTES=30

# AI服务配置
AI_SERVICE_URL=http://localhost:8001
OLLAMA_BASE_URL=http://localhost:11434

# Redis配置
REDIS_URL=redis://localhost:6379

# 文件上传
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=50MB
```

#### AI服务环境变量 (`.env.ai`)
```env
# Ollama配置
OLLAMA_BASE_URL=http://localhost:11434
DEFAULT_EMBEDDING_MODEL=bge-m3:latest

# 数据库配置
DATABASE_URL=sqlite:///./test.db

# Redis配置
REDIS_URL=redis://localhost:6379

# Azure OpenAI（可选）
AZURE_OPENAI_API_KEY=your-azure-key
AZURE_OPENAI_ENDPOINT=your-azure-endpoint
```

### 5.2. Docker环境配置

#### 使用Docker Compose（推荐）
```bash
# 开发环境
docker-compose up -d

# 生产环境
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 6. 生产环境部署

### 6.1. 生产环境要求
*   **Web服务器**: Nginx + Gunicorn
*   **数据库**: PostgreSQL 13+
*   **缓存**: Redis 6+
*   **容器化**: Docker + Docker Compose
*   **监控**: Prometheus + Grafana
*   **日志**: ELK Stack或类似方案

### 6.2. 生产部署步骤

```bash
# 1. 克隆代码
git clone <repository-url>
cd <repository-directory>

# 2. 配置生产环境变量
cp .env.example .env.production
# 编辑 .env.production 文件

# 3. 启动生产服务
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 4. 初始化数据库
docker-compose exec app alembic upgrade head
docker-compose exec app python app/initial_data.py

# 5. 验证部署
curl http://your-domain.com/health
curl http://your-domain.com/ai/health
```

### 6.3. 性能优化

```bash
# Gunicorn配置
gunicorn -k uvicorn.workers.UvicornWorker \
         -w 4 \
         --bind 0.0.0.0:8000 \
         --access-logfile - \
         --error-logfile - \
         app.main:app

# AI服务配置
gunicorn -k uvicorn.workers.UvicornWorker \
         -w 2 \
         --bind 0.0.0.0:8001 \
         --timeout 300 \
         ai_service.main:app
```

## 7. 故障排除

### 7.1. 常见问题

**AI服务启动失败**
```bash
# 检查Ollama服务
curl http://localhost:11434/api/tags

# 下载模型
ollama pull bge-m3:latest

# 检查AI服务日志
docker-compose logs ai-service
```

**数据库连接失败**
```bash
# 检查数据库状态
docker-compose ps db

# 查看数据库日志
docker-compose logs db

# 手动连接测试
psql -h localhost -U user -d audit_system
```

**向量化功能异常**
```bash
# 测试向量化功能
python test_document_vectorization.py

# 检查Redis连接
redis-cli ping

# 清理缓存
redis-cli flushall
```

### 7.2. 监控和日志

```bash
# 查看应用日志
tail -f logs/app.log

# 查看错误日志
tail -f logs/error.log

# 监控系统资源
docker stats

# 健康检查
curl http://localhost:8000/health/detailed
curl http://localhost:8001/metrics
```

---

**最后更新**: 2025-07-27  
**版本**: v1.1.0 (AI集成版本)  
**维护团队**: 开发团队  
**技术支持**: 详见项目文档